// Prisma schema for Payment Reminder App
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER ROLES
// ============================================
enum UserRole {
  ADMIN
  CLIENT
}

// ============================================
// USERS (For NextAuth Authentication)
// ============================================
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String    // Hashed password for credentials auth
  role          UserRole  @default(CLIENT)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Login tracking
  lastLoginAt   DateTime?
  lastLoginIp   String?

  // Relations
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)
  clientId String? @unique // Links to Client for CLIENT role users
  accounts Account[]
  sessions Session[]

  @@map("users")
}

// ============================================
// NEXTAUTH ACCOUNT (OAuth providers)
// ============================================
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// ============================================
// NEXTAUTH SESSION (Enhanced with device tracking)
// ============================================
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  // Device & Security tracking
  ipAddress    String?  // IP address when session was created
  userAgent    String?  @db.Text // Browser/device user agent string
  deviceType   String?  // 'desktop', 'mobile', 'tablet'
  browser      String?  // 'Chrome', 'Firefox', 'Safari', etc.
  os           String?  // 'Windows', 'macOS', 'iOS', 'Android', etc.
  location     String?  // City, Country (from IP geolocation)
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ============================================
// NEXTAUTH VERIFICATION TOKEN
// ============================================
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// CLIENTS (Law Firm's Clients)
// ============================================
model Client {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phone     String?
  whatsapp  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  borrowers Borrower[]
  templates Template[]
  user      User?      // Linked user account for login

  @@map("clients")
}

// ============================================
// BORROWERS (People who owe money to clients)
// ============================================
model Borrower {
  id        String   @id @default(cuid())
  clientId  String
  name      String
  email     String
  phone     String?
  whatsapp  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client   Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@map("borrowers")
}

// ============================================
// PAYMENTS
// ============================================
model Payment {
  id         String        @id @default(cuid())
  borrowerId String
  amount     Decimal       @db.Decimal(10, 2)
  dueDate    DateTime
  paidDate   DateTime?
  status     PaymentStatus @default(PENDING)
  caseId     String?       // Optional case reference
  notes      String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  // Relations
  borrower      Borrower       @relation(fields: [borrowerId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@map("payments")
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
}

// ============================================
// NOTIFICATIONS (Sent reminders/alerts)
// ============================================
model Notification {
  id            String           @id @default(cuid())
  paymentId     String
  type          NotificationType
  channel       NotificationChannel
  recipientType RecipientType
  recipientName String
  recipientContact String        // email or phone
  message       String           @db.Text
  sent          Boolean          @default(false)
  sentAt        DateTime?
  error         String?          // Error message if sending failed
  createdAt     DateTime         @default(now())

  // Relations
  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

enum NotificationType {
  REMINDER_7_DAY
  REMINDER_3_DAY
  REMINDER_1_DAY
  OVERDUE
  PAYMENT_RECEIVED
}

enum NotificationChannel {
  SMS
  EMAIL
  WHATSAPP
}

enum RecipientType {
  CLIENT
  BORROWER
}

// ============================================
// TEMPLATES (Customizable message templates)
// ============================================
model Template {
  id        String       @id @default(cuid())
  clientId  String?      // null = global template
  type      TemplateType
  channel   NotificationChannel
  subject   String?      // For email
  body      String       @db.Text
  active    Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relations
  client Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, type, channel])
  @@map("templates")
}

enum TemplateType {
  REMINDER_7_DAY
  REMINDER_3_DAY
  REMINDER_1_DAY
  OVERDUE
  PAYMENT_RECEIVED
}
